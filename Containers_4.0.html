<!DOCTYPE html>
    <html>
    <head>
        <meta http-equiv="Content-type" content="text/html;charset=UTF-8">
        <title>Linux Containers LXC/LXD Deep Dive</title>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.css" integrity="sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y" crossorigin="anonymous">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/markdown.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/highlight.css">
        <link href="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.css" rel="stylesheet" type="text/css">
        <style>
.task-list-item { list-style-type: none; } .task-list-item-checkbox { margin-left: -20px; vertical-align: middle; }
</style>
        <style>
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe WPC', 'Segoe UI', 'Ubuntu', 'Droid Sans', sans-serif;
                font-size: 14px;
                line-height: 1.6;
            }
        </style>
        
        <script src="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.js"></script>
    </head>
    <body>
        <h1 id="linux-containers-lxclxd-deep-dive">Linux Containers LXC/LXD Deep Dive</h1>
<ul>
<li><a href="#linux-containers-lxclxd-deep-dive">Linux Containers LXC/LXD Deep Dive</a>
<ul>
<li><a href="./GettingStarted.html">Getting Started With LXC/LXD</a>
<ul>
<li><a href="#into-to-containers">Into to Containers</a></li>
</ul>
</li>
<li><a href="#lxclxd-installation-and-configuration">LXC/LXD: Installation and Configuration</a>
<ul>
<li><a href="#setting-up-the-raspberrypi-for-running-containers">Setting up the RaspberryPi for running Containers</a></li>
<li><a href="#installing-lxclxd">Installing LXC/LXD</a>
<ul>
<li><a href="#install-lxd">Install LXD</a>
<ul>
<li><a href="#back-to-linux-academy">Back to Linux Academy</a></li>
</ul>
</li>
<li><a href="#lecture-troubleshooting-lxd-installations">Lecture: Troubleshooting LXD Installations</a></li>
</ul>
</li>
<li><a href="#launching-your-first-container">Launching Your First Container</a>
<ul>
<li><a href="#launching-your-first-container-part-1">Launching Your First Container, Part 1</a></li>
<li><a href="#launching-your-first-container-part-2">Launching Your First Container, Part 2</a></li>
</ul>
</li>
<li><a href="#lecture-launching-your-first-container-part-3">Lecture: Launching Your First Container, Part 3</a></li>
<li><a href="#exercise-launching-your-first-container">Exercise: Launching Your First Container</a></li>
</ul>
</li>
<li><a href="#lxclxd-images">LXC/LXD Images</a>
<ul>
<li><a href="#lxc-images">LXC Images</a>
<ul>
<li><a href="#lxc-images-part-1-remotes">LXC Images Part 1: Remotes</a></li>
<li><a href="#lxc-images-part-2-remotes">LXC Images Part 2: Remotes</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<blockquote>
<p>5-4-2019</p>
</blockquote>
<p><a href="https://linuxacademy.com/cp/modules/view/id/140">LXC/LXD Deep Dive</a>: goes into the Linux containers. Runs Machine containers,</p>
<h2 id="getting-started-with-lxclxd">Getting Started With LXC/LXD</h2>
<h3 id="into-to-containers">Into to Containers</h3>
<ul>
<li></li>
</ul>
<h2 id="lxclxd-installation-and-configuration">LXC/LXD: Installation and Configuration</h2>
<h3 id="setting-up-the-raspberrypi-for-running-containers">Setting up the RaspberryPi for running Containers</h3>
<blockquote>
<p><code>Raspbian 2019-4-8</code> currently doesn't allow containerization.</p>
</blockquote>
<ul>
<li>Downloaded <a href="https://wiki.ubuntu.com/ARM/RaspberryPi#Booting_generic_arm64_ISO_images">ubuntu 18.04</a> RPi 3B iso image.</li>
<li>Installed with the Etcher app on the microSD</li>
<li>Booted the RaspberryPi and ran the initial setup.</li>
<li>used <code>ssh ubuntu@&lt;ipaddress&gt;</code> to get access into the Pi.</li>
</ul>
<h3 id="installing-lxclxd">Installing LXC/LXD</h3>
<h4 id="install-lxd">Install LXD</h4>
<p>Next we check for the LXC and <code>lxc-config</code> apps:</p>
<pre><code><div>$ whereis lxd
lxd: /usr/bin/lxd /usr/lib/lxd /usr/share/man/man1/lxd.1.gz
$ whereis lxd-client
lxd-client:
$ sudo apt install lxd-client lxd
...
lxd-client is already the newest version (3.0.3-0ubuntu1~18.04.1).
...
</div></code></pre>
<h5 id="back-to-linux-academy">Back to Linux Academy</h5>
<blockquote>
<p>Started the RPi and did <code>update</code> and <code>upgrade</code></p>
</blockquote>
<p>Setup lxd with:</p>
<pre><code><div>$ sudo lxd init
Would you like to use LXD clustering? (yes/no) [default=no]: 
Do you want to configure a new storage pool? (yes/no) [default=yes]:
Would you like to connect to a MAAS server? (yes/no) [default=no]: 
Would you like to create a new local network bridge? (yes/no) [default=yes]: 
What should the new bridge be called? [default=lxdbr0]: 
The requested network bridge &quot;lxdbr0&quot; already exists. Please choose another name.
What should the new bridge be called? [default=lxdbr0]: lsdbr0
What IPv4 address should be used? (CIDR subnet notation, “auto” or “none”) [default=auto]: 
What IPv6 address should be used? (CIDR subnet notation, “auto” or “none”) [default=auto]: 
Would you like LXD to be available over the network? (yes/no) [default=no]: yes
Address to bind LXD to (not including port) [default=all]: 
Port to bind LXD to [default=8443]: 
Trust password for new clients: 
Again: 
Would you like stale cached images to be updated automatically? (yes/no) [default=yes] 
Would you like a YAML &quot;lxd init&quot; preseed to be printed? (yes/no) [default=no]:
</div></code></pre>
<p>NOTE: The above is mostly default.</p>
<p>Download / create a new container:</p>
<pre><code><div>lxc launch ubuntu:18.04 ubuntu
</div></code></pre>
<p>Now we'll go into the new container:</p>
<pre><code><div>$ lxc exec ubuntu -- /bin/bash
</div></code></pre>
<p>And let's look around:</p>
<pre><code><div>$ ls -al
...
$ cd \
$ df -h
...
$ exit
</div></code></pre>
<p>Here we will download and create a new container:</p>
<pre><code><div>$ lxc launch images:alpine/3.8 alpine
$ lxc list
...
</div></code></pre>
<p>Now Alpine is a very small container and doesn't have alot of functionality so to look around we'll use <code>ash</code>:</p>
<pre><code><div>$ lxc exec alpine -- ash
~ # ls -al
...
~ # cd \
~ # df -h
...
~ # exit
</div></code></pre>
<h4 id="lecture-troubleshooting-lxd-installations">Lecture: Troubleshooting LXD Installations</h4>
<p>I didn't have any problems. and most of what he did here was what was done in the beginning. The only note would be to re-run the <code>dpkg-reconfigure</code>:</p>
<pre><code><div>$ sudo dpkg-reconfigure -p medium lxd
</div></code></pre>
<h3 id="launching-your-first-container">Launching Your First Container</h3>
<h4 id="launching-your-first-container-part-1">Launching Your First Container, Part 1</h4>
<p>Now create a local copy of a container and name it alp:</p>
<pre><code><div>$ lxc image copy images:alpine/3.8 local: --alias alp
</div></code></pre>
<p>Launch a new container</p>
<pre><code><div>lxc launch alp web
</div></code></pre>
<p>Check for updates out side the container</p>
<pre><code><div>$ lxc exec web -- apk update
</div></code></pre>
<p>Move into the container with /bin/bash or ash or bashsh</p>
<pre><code><div>$ lxc exec web -- ash
</div></code></pre>
<p>add nginx to the <code>web</code> container</p>
<pre><code><div>$ apk add nginx
</div></code></pre>
<p>Next is neat, we will edit a config file inside the <code>web</code> container from the host PC while <code>ssh</code>ing into the host PC:</p>
<pre><code><div>$ lxc file edit web/etc/nginx/conf.d/default.conf
</div></code></pre>
<p>Remove most of the file, in the end it should look like:</p>
<pre><code><div>server {
        listen 80 default_server;
        listen [::]:80 default_server;

        root /var/www;
}
</div></code></pre>
<h4 id="launching-your-first-container-part-2">Launching Your First Container, Part 2</h4>
<p>Enter the container and take a look at the web/etc/nginx/conf.d/default.conf and contents of /var/www</p>
<p>Create a index.html inside the <code>web</code> container without ever entering it (i.e. from outside the container)</p>
<pre><code>    $ lcx file edit web/var/www/index.html
    Served from the web container!
    ...
</code></pre>
<p>Check the web</p>
<pre><code>    $ curl 10.186.94.33
</code></pre>
<p>Create a snapshot of the container</p>
<pre><code>    $ lxc snapshot web initialconfig
</code></pre>
<p>Restore a snapshot</p>
<pre><code>    $ lxc restore web initialconfig
</code></pre>
<p>Test restore!!!</p>
<h3 id="lecture-launching-your-first-container-part-3">Lecture: Launching Your First Container, Part 3</h3>
<p><strong>Snapshots!!!</strong> can be used to spin up containers when using <strong>load balancers</strong></p>
<p>Create a new container from the initial config snapshot of <code>web</code>:</p>
<pre><code>    $ lxc copy web/initialconfig web2
</code></pre>
<p>Check and then start the container:</p>
<pre><code>    $ lxc list
    ...
    $ lxc start web2
    $ lxc list
    ...
</code></pre>
<blockquote>
<p>5-5-2019</p>
</blockquote>
<p>Edit HTML pages of both the <code>web2</code> and <code>web</code> containers from outside. Again these container are running on the RaspberryPi, hardwired into my local network.</p>
<pre><code>    $ lcx file edit web2/var/www/index.html
    Served from the web2 container!

    $ lcx file edit web2/var/www/index.html
    Served from the first web container!
</code></pre>
<p>Now we'll take an other snapshot:</p>
<pre><code>    $ lxc snapshot web 1.1
    $ lxc snapshot web2 1.1
</code></pre>
<p>Calling them both <code>1.1</code> will show that they are synchronized.</p>
<p>Now we'll <code>delete</code> a snapshot:</p>
<pre><code>    $ lxc delete web/1.1
</code></pre>
<p>Note that trying to delete a running container will:</p>
<pre><code>    $ lxc delete web
    Error: The container is currently running, stop it first or pass --force
</code></pre>
<p>Remember to check on what containers are running:</p>
<pre><code>    $ lxc list
</code></pre>
<p>Lets cleanup by stopping the running containers and then deleting them:</p>
<pre><code>    $ lxc stop web
    $ lxc stop web2
    $ lxc delete web
    $ lxc delete web2
    $ lxc list
</code></pre>
<p>Now lets list and delete some of the images we have saved:</p>
<pre><code>    $ lxc image list
    .
    .
    .
    $ lxc image delete alp
    .
    .
    .   
</code></pre>
<h3 id="exercise-launching-your-first-container">Exercise: Launching Your First Container</h3>
<ol>
<li>Launch a container named 'web' based on the Alpine v3.5 image.</li>
<li>Install and configure nginx in your new container without logging in to the container's console.</li>
<li>Create a test page called &quot;index.html&quot; and place it in the web root with the following content:  &quot;Web page served out of an LXC container!&quot;</li>
<li>Log into the container's console and set nginx to automatically start when the container starts (The command is rc-update add nginx default.)</li>
<li>Start nginx in your container.</li>
<li>Exit your container and verify that everything is functioning as expected using the curl command with your container's IP address. Note that this is a private IP address and will only be accessible from the console of the LXD host.</li>
<li>Create a snapshot of your container called 1.0.</li>
<li>Change the contents of the index.html in the web root to read, &quot;Typos are horrible!&quot; and verify the changes took place with curl.</li>
<li>Create a snapshot of your container called 1.1.</li>
<li>Restore your container to the 1.0 state and verify that the changes took place.</li>
<li>Delete the 1.1 snapshot.</li>
</ol>
<h2 id="lxclxd-images">LXC/LXD Images</h2>
<h3 id="lxc-images">LXC Images</h3>
<h4 id="lxc-images-part-1-remotes">LXC Images Part 1: Remotes</h4>
<p>5/5/2019 5:00pm
NOTE: upon restart of the RaspberryPi <code>$ lxc list</code> would hang, as would all commands to <code>lxd</code>. Removed and reinstalled <code>lxd</code> and <code>lxd-client</code>.
Then ran through starting up the lxd services.</p>
<p>Where do these images come from? <strong>LXC remotes</strong> use the following to see what remote repositories currently setup on the machine:</p>
<pre><code><div>$ lxc remote list 
...
</div></code></pre>
<p>To create your own remote (I used a container on the Pi to be the host of a repository):</p>
<p>Log into your <strong>remote</strong> machine you'd like to use as a repository and locate the ip address listed as <code>inet addr: &lt;ipaddress&gt;</code></p>
<pre><code><div>$ ifconfig
... inet addr: 
...
</div></code></pre>
<p>Set the port and address to listen to:</p>
<pre><code>    $ lxc config set core.https_address &quot;[::]:8443&quot;
</code></pre>
<p>Set the password so that other <code>lxd daemons</code> can use to access the lxd server as a remote.</p>
<pre><code>    $ lxc config set core.trust_password &lt;password&gt;
    exit
</code></pre>
<p>Now return to the main machine and add the remote:</p>
<pre><code><div>$ lxc remote add second 172.31.23.109:8443 --password=secret
$ lxc list second:
</div></code></pre>
<p>To see images available that are currently installed on on other lxd servers:</p>
<pre><code><div>$ lxc image list
$ lxc image list second:
</div></code></pre>
<h4 id="lxc-images-part-2-remotes">LXC Images Part 2: Remotes</h4>

    </body>
    </html>